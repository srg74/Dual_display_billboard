<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Billboard Settings</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="main-container">
        <div class="flex-container-gray">
            <div class="header-block">
                <h1 class="billboard-name">BILLBOARD SETTINGS</h1>
                <div class="header-center">
                    <a href="/">Back to Main Page</a>
                </div>
                <div>
                    <p><strong>Wi-Fi:</strong> <span class="status-value">{{WIFI_SSID}}</span></p>
                    <p><strong>IP:</strong> <span class="status-value">{{IP_ADDRESS}}</span></p>
                </div>
            </div>
        </div>

        <h2>WiFi Information</h2>
        <div class="flex-container-gray">
            <label><strong>Network:</strong></label>
            <span id="wifi-ssid" class="status-value">{{WIFI_SSID}}</span>
        </div>
        <div class="flex-container-gray">
            <label><strong>IP Address:</strong></label>
            <span id="wifi-ip" class="status-value">{{IP_ADDRESS}}</span>
        </div>
        <div class="flex-container-gray">
            <label><strong>Signal:</strong></label>
            <span id="wifi-rssi" class="status-value">{{WIFI_RSSI}} dBm</span>
        </div>

        <h2>System Information</h2>
        <div class="flex-container-gray">
            <label><strong>Uptime:</strong></label>
            <span id="system-uptime" class="status-value">{{UPTIME}} seconds</span>
        </div>
        <div class="flex-container-gray">
            <label><strong>Memory Health:</strong></label>
            <span id="memory-health" class="status-value">Loading...</span>
        </div>
        <div class="flex-container-gray">
            <label><strong>Heap Free:</strong></label>
            <span id="heap-free" class="status-value">{{FREE_MEMORY}} bytes</span>
        </div>
        <div class="flex-container-gray">
            <label><strong>Heap Total:</strong></label>
            <span id="heap-total" class="status-value">Loading...</span>
        </div>
        <div class="flex-container-gray">
            <label><strong>Heap Usage:</strong></label>
            <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                <div style="flex: 1; background-color: #30363d; border-radius: 4px; height: 8px; overflow: hidden;">
                    <div id="heap-usage-bar" style="height: 100%; background: linear-gradient(90deg, #2ea043 0%, #fb8500 70%, #d73a49 90%); width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <span id="heap-usage-text" class="status-value">0%</span>
            </div>
        </div>
        <div class="flex-container-gray">
            <label><strong>Heap Fragmentation:</strong></label>
            <span id="heap-fragmentation" class="status-value">Loading...</span>
        </div>
        <div class="flex-container-gray" id="psram-section" style="display: none;">
            <label><strong>PSRAM Free:</strong></label>
            <span id="psram-free" class="status-value">N/A</span>
        </div>
        <div class="flex-container-gray" id="psram-total-section" style="display: none;">
            <label><strong>PSRAM Total:</strong></label>
            <span id="psram-total" class="status-value">N/A</span>
        </div>
        <div class="flex-container-gray">
            <label><strong>Low Memory Events:</strong></label>
            <span id="low-memory-events" class="status-value">0</span>
        </div>
        <div class="flex-container-gray">
            <label><strong>Critical Events:</strong></label>
            <span id="critical-events" class="status-value">0</span>
        </div>

        <h2>NTP Server Configuration</h2>
        <div class="flex-container-gray">
            <label><strong>Primary Server:</strong></label>
            <div style="display: flex; gap: 8px; align-items: center; flex: 1;">
                                <input type="text" id="ntp-server1" value="{{CURRENT_NTP_SERVER}}" 
                       style="flex: 1; padding: 6px; border: 1px solid #30363d; border-radius: 4px; background-color: #0d1117; color: #f0f6fc; font-size: 14px;"
                       placeholder="Enter NTP server URL">
                <select onchange="setNTPFromDropdown()" 
                        style="padding: 6px; border: 1px solid #30363d; border-radius: 4px; background-color: #0d1117; color: #f0f6fc; font-size: 14px;">
                    <option value="">Quick Select...</option>
                    <option value="pool.ntp.org">pool.ntp.org</option>
                    <option value="time.nist.gov">time.nist.gov</option>
                    <option value="time.google.com">time.google.com</option>
                    <option value="time.cloudflare.com">time.cloudflare.com</option>
                </select>
            </div>
            <button onclick="updateNTPServer()">Update NTP</button>
        </div>

        <h2>Clock Settings</h2>
        <div class="flex-container-gray">
            <div class="clock-face-container">
                <div class="clock-face-label">Clock Face Style:</div>
                <div class="clock-face-grid">
                    <div>
                        <label class="clock-face-option" for="clockFace0">
                            <input type="radio" id="clockFace0" name="clockFace" value="0" onchange="changeClockFace()">
                            <div class="clock-preview">
                                <div class="analog-preview">
                                    <div class="clock-circle">
                                        <div class="hour-hand"></div>
                                        <div class="minute-hand"></div>
                                        <div class="center-dot"></div>
                                    </div>
                                </div>
                                <span>Classic Analog</span>
                            </div>
                        </label>
                        <label class="clock-face-option" for="clockFace1">
                            <input type="radio" id="clockFace1" name="clockFace" value="1" onchange="changeClockFace()">
                            <div class="clock-preview">
                                <div class="digital-preview">
                                    <div class="digital-time">12:34</div>
                                    <div class="digital-seconds">:56</div>
                                </div>
                                <span>Digital Modern</span>
                            </div>
                        </label>
                        <label class="clock-face-option" for="clockFace2">
                            <input type="radio" id="clockFace2" name="clockFace" value="2" onchange="changeClockFace()">
                            <div class="clock-preview">
                                <div class="minimalist-preview">
                                    <div class="minimalist-time">12:34</div>
                                    <div class="minimalist-line"></div>
                                </div>
                                <span>Minimalist</span>
                            </div>
                        </label>
                        <label class="clock-face-option" for="clockFace3">
                            <input type="radio" id="clockFace3" name="clockFace" value="3" onchange="changeClockFace()">
                            <div class="clock-preview">
                                <div class="colorful-preview">
                                    <div class="modern-clock-face">
                                        <!-- Major hour markers -->
                                        <div class="modern-hour-marker h12"></div>
                                        <div class="modern-hour-marker h3"></div>
                                        <div class="modern-hour-marker h6"></div>
                                        <div class="modern-hour-marker h9"></div>
                                        <!-- Minor hour markers -->
                                        <div class="modern-hour-marker minor h1"></div>
                                        <div class="modern-hour-marker minor h2"></div>
                                        <div class="modern-hour-marker minor h4"></div>
                                        <div class="modern-hour-marker minor h5"></div>
                                        <div class="modern-hour-marker minor h7"></div>
                                        <div class="modern-hour-marker minor h8"></div>
                                        <div class="modern-hour-marker minor h10"></div>
                                        <div class="modern-hour-marker minor h11"></div>
                                        <!-- Clock hands -->
                                        <div class="modern-hour-hand"></div>
                                        <div class="modern-minute-hand"></div>
                                        <div class="modern-center-dot"></div>
                                    </div>
                                    <div class="colorful-time">10:15</div>
                                </div>
                                <span>Modern Square</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <h2>DCC Settings</h2>
        <div class="flex-container-gray">
            <div class="control-section">
                <label for="dccCheckbox"><strong>Enable DCC interface</strong></label>
                <label class="toggle-switch">
                    <input type="checkbox" id="dccCheckbox" onchange="toggleDCC()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        
        <div class="flex-container-gray">
            <label for="dccAddress"><strong>DCC Address:</strong></label>
            <input type="number" id="dccAddress" value="101" min="1" max="2048" placeholder="101">
            <button onclick="setDCCAddress()">Set Address</button>
        </div>
        
        <div class="flex-container-gray">
            <label for="dccPin"><strong>DCC GPIO Pin:</strong></label>
            <input type="number" id="dccPin" value="4" min="0" max="39" placeholder="4">
            <button onclick="setDCCPin()">Set Pin</button>
        </div>

        <h2>System Control</h2>
        <div class="flex-container-gray">
            <label><strong>Portal Mode:</strong></label>
            <button class="btn-success" onclick="activatePortalMode()">Switch to Portal</button>
        </div>
        <div class="flex-container-gray">
            <label><strong>Factory Reset:</strong></label>
            <button class="btn-warning" onclick="confirmFactoryReset()">Factory Reset</button>
        </div>
        <div class="flex-container-gray">
            <label><strong>Refresh:</strong></label>
            <button onclick="refreshInfo()">Update Data</button>
        </div>

        <h2>Firmware Update (OTA)</h2>
        <div class="flex-container-gray">
            <label><strong>Current Version:</strong></label>
            <span id="firmware-version" class="status-value">v2.0</span>
        </div>
        <div class="flex-container-gray">
            <label><strong>Build:</strong></label>
            <span id="build-date" class="status-value">Loading...</span>
        </div>
        <div class="flex-container-gray">
            <label><strong>Build Type:</strong></label>
            <span id="build-type" class="status-value">Loading...</span>
        </div>
        <div class="flex-container-gray">
            <label><strong>Upload Firmware:</strong></label>
            <input type="file" id="firmwareFile" accept=".bin" onchange="validateFirmwareFile()">
        </div>
        <div class="flex-container-gray" id="firmware-info" style="display: none;">
            <label><strong>File Info:</strong></label>
            <span id="firmware-details" class="status-value">No file selected</span>
        </div>
        <div class="flex-container-gray">
            <label><strong>Update Progress:</strong></label>
            <div style="flex: 1; margin-left: 10px;">
                <div style="background: #30363d; border-radius: 4px; height: 20px; overflow: hidden;">
                    <div id="ota-progress-bar" style="height: 100%; background: linear-gradient(90deg, #2ea043 0%, #fb8500 70%, #d73a49 90%); width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <span id="ota-progress-text" class="status-value">Ready</span>
            </div>
        </div>
        <div class="flex-container-gray">
            <label><strong>Action:</strong></label>
            <button id="upload-firmware-btn" class="btn-warning" onclick="uploadFirmware()" disabled>Upload Firmware</button>
        </div>
    </div>

    <script>
        // Auto-refresh every 60 seconds (reduced from 30s for better performance)
        setInterval(refreshInfo, 60000);
        window.onload = refreshInfo;

        function refreshInfo() {
            // Add timeout and error handling to prevent hanging requests
            const fetchWithTimeout = (url, timeout = 5000) => {
                return Promise.race([
                    fetch(url),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout')), timeout)
                    )
                ]);
            };

            fetchWithTimeout('/api/wifi-status')
                .then(r => r.json())
                .then(d => {
                    document.getElementById('wifi-ssid').textContent = d.ssid || 'N/A';
                    document.getElementById('wifi-ip').textContent = d.ip || 'N/A';
                    document.getElementById('wifi-rssi').textContent = (d.rssi || 0) + ' dBm';
                })
                .catch(() => console.log('WiFi status update failed'));

            fetchWithTimeout('/api/system-info')
                .then(r => r.json())
                .then(d => {
                    document.getElementById('system-uptime').textContent = formatTime(d.uptime || 0);
                    // Legacy support for basic memory display
                    if (document.getElementById('system-memory')) {
                        document.getElementById('system-memory').textContent = formatBytes(d.freeMemory || 0);
                    }
                })
                .catch(() => console.log('System info update failed'));

            // Enhanced memory monitoring
            fetchWithTimeout('/api/memory-status')
                .then(r => r.json())
                .then(d => {
                    // Update memory health with color coding
                    const healthElement = document.getElementById('memory-health');
                    const health = d.overallHealth || 'UNKNOWN';
                    healthElement.textContent = health;
                    
                    // Color code health status
                    healthElement.style.color = getHealthColor(health);
                    
                    // Update heap information
                    document.getElementById('heap-free').textContent = formatBytes(d.heapFree || 0);
                    document.getElementById('heap-total').textContent = formatBytes(d.heapTotal || 0);
                    
                    // Update heap usage bar and text
                    const heapUsage = d.heapUsagePercent || 0;
                    document.getElementById('heap-usage-bar').style.width = heapUsage + '%';
                    document.getElementById('heap-usage-text').textContent = heapUsage.toFixed(1) + '%';
                    
                    // Update fragmentation
                    document.getElementById('heap-fragmentation').textContent = (d.heapFragmentation || 0).toFixed(1) + '%';
                    
                    // Update PSRAM if available
                    if (d.psramAvailable) {
                        document.getElementById('psram-section').style.display = 'flex';
                        document.getElementById('psram-total-section').style.display = 'flex';
                        document.getElementById('psram-free').textContent = formatBytes(d.psramFree || 0);
                        document.getElementById('psram-total').textContent = formatBytes(d.psramTotal || 0);
                    } else {
                        document.getElementById('psram-section').style.display = 'none';
                        document.getElementById('psram-total-section').style.display = 'none';
                    }
                    
                    // Update event counters
                    document.getElementById('low-memory-events').textContent = d.lowMemoryEvents || 0;
                    document.getElementById('critical-events').textContent = d.criticalEvents || 0;
                })
                .catch(() => {
                    console.log('Memory status update failed');
                    // Fallback to basic memory info
                    document.getElementById('memory-health').textContent = 'UNAVAILABLE';
                    document.getElementById('memory-health').style.color = '#6e7681';
                });

            // Load build information
            fetchWithTimeout('/api/build-info')
                .then(r => r.json())
                .then(d => {
                    document.getElementById('firmware-version').textContent = d.version || 'Unknown';
                    document.getElementById('build-date').textContent = d.buildDate || 'Unknown';
                    document.getElementById('build-type').textContent = d.buildType || 'Unknown';
                })
                .catch(() => {
                    console.log('Build info update failed');
                    document.getElementById('build-date').textContent = 'Unavailable';
                    document.getElementById('build-type').textContent = 'Unavailable';
                });

            // Load current settings including DCC state
            fetchWithTimeout('/api/settings')
                .then(r => r.json())
                .then(d => {
                    // Set DCC checkbox to match server state (defaults to false)
                    document.getElementById('dccCheckbox').checked = d.dcc || false;
                    // Update DCC address and pin fields
                    document.getElementById('dccAddress').value = d.dccAddress || 101;
                    document.getElementById('dccPin').value = d.dccPin || 4;
                })
                .catch(() => console.log('Settings update failed'));
        }

        function formatTime(s) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            return h > 0 ? h + 'h ' + m + 'm' : m + 'm ' + (s % 60) + 's';
        }

        function formatBytes(b) {
            if (b === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(b) / Math.log(k));
            return parseFloat((b / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function getHealthColor(health) {
            switch(health) {
                case 'EXCELLENT': return '#2ea043';  // Green
                case 'GOOD': return '#3fb950';       // Light green
                case 'WARNING': return '#fb8500';    // Orange
                case 'CRITICAL': return '#f85149';   // Red
                case 'EMERGENCY': return '#da3633';  // Dark red
                default: return '#6e7681';           // Gray
            }
        }

        function activatePortalMode() {
            if (confirm('Switch to Portal Mode? This will disconnect WiFi.')) {
                fetch('/api/portal-mode', { method: 'POST' })
                    .then(r => r.json())
                    .then(d => {
                        alert('Switching to Portal Mode...');
                        setTimeout(() => window.location.href = '/', 2000);
                    });
            }
        }

        function confirmFactoryReset() {
            if (confirm('FACTORY RESET: This will erase all settings!')) {
                if (confirm('This cannot be undone. Continue?')) {
                    fetch('/factory-reset', { method: 'POST' })
                        .then(r => r.json())
                        .then(d => alert('Factory reset initiated.'));
                }
            }
        }

        function updateNTPServer() {
            const server = document.getElementById('ntp-server1').value;
            
            fetch('/api/ntp-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'server=' + encodeURIComponent(server)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('NTP server updated successfully!');
                } else {
                    alert('Error updating NTP server: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error updating NTP server:', error);
                alert('Network error updating NTP server');
            });
        }

        function setNTPFromDropdown() {
            const dropdown = event.target;
            const inputField = document.getElementById('ntp-server1');
            if (dropdown.value) {
                inputField.value = dropdown.value;
                dropdown.selectedIndex = 0; // Reset dropdown to "Quick Select..."
            }
        }

        function changeClockFace() {
            const selectedRadio = document.querySelector('input[name="clockFace"]:checked');
            if (selectedRadio) {
                const faceType = selectedRadio.value;
                const xhr = new XMLHttpRequest();
                xhr.open("POST", "/clockface", true);
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        console.log('Clock face updated successfully');
                    } else {
                        alert('Error updating clock face');
                    }
                };
                xhr.send("face=" + faceType);
            }
        }

        function loadClockFaceSettings() {
            fetch('/api/settings')
                .then(response => response.json())
                .then(settings => {
                    console.log('Loaded settings:', settings);
                    
                    // Set the clock face radio button
                    const clockFaceValue = settings.clockFace || 0;
                    const clockFaceRadio = document.getElementById('clockFace' + clockFaceValue);
                    if (clockFaceRadio) {
                        clockFaceRadio.checked = true;
                        console.log('Clock face set to:', clockFaceValue);
                    }
                })
                .catch(error => {
                    console.error('Error loading clock face settings:', error);
                });
        }

        // DCC functions
        function toggleDCC() {
            var checked = document.getElementById('dccCheckbox').checked;
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/dcc", true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.send("dcc=" + checked);
        }

        function setDCCAddress() {
            var address = document.getElementById('dccAddress').value;
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/dccaddress", true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onload = function() {
                if (xhr.status === 200) {
                    alert('DCC address set to: ' + address);
                } else {
                    alert('Failed to set DCC address');
                }
            };
            xhr.send("address=" + address);
        }

        function setDCCPin() {
            var pin = document.getElementById('dccPin').value;
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/dccpin", true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onload = function() {
                if (xhr.status === 200) {
                    alert('DCC GPIO pin set to: ' + pin);
                } else {
                    alert('Failed to set DCC pin');
                }
            };
            xhr.send("pin=" + pin);
        }

        function loadDCCSettings() {
            fetch('/api/settings')
                .then(response => response.json())
                .then(settings => {
                    console.log('Loading DCC settings:', settings);
                    
                    // Set DCC checkbox
                    const dccCheckbox = document.getElementById('dccCheckbox');
                    if (dccCheckbox) {
                        dccCheckbox.checked = settings.dcc || false;
                    }
                    
                    // Set DCC address
                    const dccAddress = document.getElementById('dccAddress');
                    if (dccAddress) {
                        dccAddress.value = settings.dccAddress || 101;
                    }
                    
                    // Set DCC pin
                    const dccPin = document.getElementById('dccPin');
                    if (dccPin) {
                        dccPin.value = settings.dccPin || 4;
                    }
                })
                .catch(error => {
                    console.error('Error loading DCC settings:', error);
                });
        }

        // Load settings when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadClockFaceSettings();
            loadDCCSettings();
        });

        // OTA Firmware Update Functions
        function validateFirmwareFile() {
            const fileInput = document.getElementById('firmwareFile');
            const uploadBtn = document.getElementById('upload-firmware-btn');
            const firmwareInfo = document.getElementById('firmware-info');
            const firmwareDetails = document.getElementById('firmware-details');
            
            if (fileInput.files.length === 0) {
                uploadBtn.disabled = true;
                firmwareInfo.style.display = 'none';
                return;
            }
            
            const file = fileInput.files[0];
            const fileSize = file.size;
            const fileName = file.name;
            
            // Basic validation
            if (!fileName.endsWith('.bin')) {
                firmwareDetails.textContent = 'Error: Only .bin files are allowed';
                firmwareDetails.style.color = '#f85149';
                firmwareInfo.style.display = 'flex';
                uploadBtn.disabled = true;
                return;
            }
            
            // Size validation (expect 1-4MB for ESP32 firmware)
            if (fileSize < 100000 || fileSize > 4194304) {
                firmwareDetails.textContent = `Error: File size ${formatBytes(fileSize)} seems invalid for ESP32 firmware`;
                firmwareDetails.style.color = '#f85149';
                firmwareInfo.style.display = 'flex';
                uploadBtn.disabled = true;
                return;
            }
            
            // Validate firmware filename compatibility
            fetch(`/api/validate-firmware?filename=${encodeURIComponent(fileName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.valid) {
                        // File looks valid
                        firmwareDetails.textContent = `${fileName} (${formatBytes(fileSize)}) - Ready to upload`;
                        firmwareDetails.style.color = '#2ea043';
                        firmwareInfo.style.display = 'flex';
                        uploadBtn.disabled = false;
                    } else {
                        // File is not compatible
                        firmwareDetails.textContent = `Error: ${data.error}`;
                        firmwareDetails.style.color = '#f85149';
                        firmwareInfo.style.display = 'flex';
                        uploadBtn.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Firmware validation error:', error);
                    // Fall back to showing the file but with a warning
                    firmwareDetails.textContent = `${fileName} (${formatBytes(fileSize)}) - Warning: Could not validate compatibility`;
                    firmwareDetails.style.color = '#fb8500';
                    firmwareInfo.style.display = 'flex';
                    uploadBtn.disabled = false;
                });
        }
        
        function uploadFirmware() {
            const fileInput = document.getElementById('firmwareFile');
            const uploadBtn = document.getElementById('upload-firmware-btn');
            const progressBar = document.getElementById('ota-progress-bar');
            const progressText = document.getElementById('ota-progress-text');
            
            if (fileInput.files.length === 0) {
                alert('Please select a firmware file first');
                return;
            }
            
            if (!confirm('FIRMWARE UPDATE: This will restart the device. Continue?')) {
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('firmware', file);
            
            // Disable upload button and show progress
            uploadBtn.disabled = true;
            progressText.textContent = 'Uploading...';
            progressBar.style.width = '0%';
            
            const xhr = new XMLHttpRequest();
            
            // Track upload progress
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBar.style.width = percentComplete + '%';
                    progressText.textContent = `Uploading: ${Math.round(percentComplete)}%`;
                }
            });
            
            // Handle completion
            xhr.addEventListener('load', function() {
                if (xhr.status === 200) {
                    progressBar.style.width = '100%';
                    progressText.textContent = 'Upload complete - Device restarting...';
                    
                    // Show success message and countdown
                    let countdown = 30;
                    const countdownInterval = setInterval(() => {
                        progressText.textContent = `Firmware updated! Device restarting... (${countdown}s)`;
                        countdown--;
                        
                        if (countdown <= 0) {
                            clearInterval(countdownInterval);
                            location.reload(); // Refresh page after restart
                        }
                    }, 1000);
                    
                } else {
                    progressText.textContent = 'Upload failed: ' + (xhr.responseText || 'Unknown error');
                    uploadBtn.disabled = false;
                }
            });
            
            // Handle errors
            xhr.addEventListener('error', function() {
                progressText.textContent = 'Upload failed: Network error';
                uploadBtn.disabled = false;
            });
            
            // Send the file
            xhr.open('POST', '/ota-update');
            xhr.send(formData);
        }
    </script>
</body>
</html>
